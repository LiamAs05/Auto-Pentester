import unittest
from requests import Response
from src.communicator.requests_wrapper import RequestsWrapper


class HeadersTestCase(unittest.TestCase):
    def test_add_header(self):
        wrapper = RequestsWrapper("https://stackoverflow.com")
        curr_headers = wrapper.session.headers.copy()

        wrapper.add_header("Hello", "World")
        self.assertNotEqual(curr_headers, wrapper.session.headers)

    def test_remove_header(self):
        wrapper = RequestsWrapper("https://stackoverflow.com")
        curr_headers = wrapper.session.headers.copy()

        wrapper.add_header("Hello", "World")
        self.assertNotEqual(curr_headers, wrapper.session.headers)
        wrapper.remove_header("Hello")
        self.assertEqual(curr_headers, wrapper.session.headers)

    def test_empty_key(self):
        wrapper = RequestsWrapper("https://stackoverflow.com")
        curr_headers = wrapper.session.headers.copy()
        try:
            wrapper.add_header("", "This should not work")
            self.assertEqual(curr_headers, wrapper.session.headers)
        except Exception as e:
            self.assertEqual(KeyError, type(e))

    def test_none_key(self):
        wrapper = RequestsWrapper("https://stackoverflow.com")
        curr_headers = wrapper.session.headers.copy()

        try:
            wrapper.add_header(None, "This should not work either")
            self.assertEqual(curr_headers, wrapper.session.headers)
        except Exception as e:
            self.assertEqual(KeyError, type(e))

    def test_none_value(self):
        wrapper = RequestsWrapper("https://stackoverflow.com")
        curr_headers = wrapper.session.headers.copy()

        try:
            wrapper.add_header("This should also throw", None)
            self.assertEqual(curr_headers, wrapper.session.headers)
        except Exception as e:
            self.assertEqual(ValueError, type(e))


class CookiesTestCase(unittest.TestCase):
    def test_add_cookie(self):
        wrapper = RequestsWrapper("https://stackoverflow.com")
        curr_cookies = wrapper.session.cookies.copy()

        wrapper.add_cookie("Hello", "World")
        self.assertNotEqual(curr_cookies, wrapper.session.cookies)

    def test_remove_cookie(self):
        wrapper = RequestsWrapper("https://stackoverflow.com")
        curr_cookies = wrapper.session.cookies.copy()

        wrapper.add_cookie("Hello", "World")
        self.assertNotEqual(curr_cookies, wrapper.session.cookies)
        wrapper.remove_cookie("Hello")
        self.assertEqual(curr_cookies, wrapper.session.cookies)

    def test_empty_key(self):
        wrapper = RequestsWrapper("https://stackoverflow.com")
        curr_cookies = wrapper.session.cookies.copy()
        try:
            wrapper.add_cookie("", "This should not work")
            self.assertEqual(curr_cookies, wrapper.session.cookies)
        except Exception as e:
            self.assertEqual(KeyError, type(e))

    def test_none_key(self):
        wrapper = RequestsWrapper("https://stackoverflow.com")
        curr_cookies = wrapper.session.cookies.copy()

        try:
            wrapper.add_cookie(None, "This should not work either")
            self.assertEqual(curr_cookies, wrapper.session.cookies)
        except Exception as e:
            self.assertEqual(KeyError, type(e))

    def test_none_value(self):
        wrapper = RequestsWrapper("https://stackoverflow.com")
        curr_cookies = wrapper.session.cookies.copy()

        try:
            wrapper.add_cookie("This should also throw", None)
            self.assertEqual(curr_cookies, wrapper.session.cookies)
        except Exception as e:
            self.assertEqual(ValueError, type(e))


class RequestTestCase(unittest.TestCase):
    def test_init(self):
        wrapper = RequestsWrapper("https://www.youtube.com/watch")
        sec_wrapper = RequestsWrapper("https://www.youtube.com/watch", headers={"Hello": "World"})
        self.assertNotEqual(wrapper.session.headers, sec_wrapper.session.headers)
        self.assertEqual(wrapper.session.cookies, sec_wrapper.session.cookies)
        wrapper.close_session()
        wrapper = RequestsWrapper("https://www.youtube.com/watch", cookies={"Haha": "Inequality"})
        self.assertNotEqual(wrapper.session.headers, sec_wrapper.session.headers)

    def test_get(self):
        wrapper = RequestsWrapper("https://www.youtube.com/watch")
        res = wrapper.get(params={"v": "fHI8X4OXluQ"})
        self.assertEqual(type(res), Response)
        self.assertEqual(wrapper.url, "https://www.youtube.com/watch")
        self.assertEqual(res.url, "https://www.youtube.com/watch?v=fHI8X4OXluQ")
        self.assertIn("Blinding Lights", res.text)

    def test_post(self):
        wrapper = RequestsWrapper("https://httpbin.org/anything")
        res = wrapper.post(data={"Hello": "World!"})
        self.assertEqual(type(res), Response)
        self.assertEqual(res.url, "https://httpbin.org/anything")
        self.assertIn('"method": "POST",', res.text)
        self.assertIn('"Hello": "World!"', res.text)


if __name__ == '__main__':
    unittest.main()
