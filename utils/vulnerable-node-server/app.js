const express = require('express');
const app = express();
const bodyParser = require('body-parser');
const sqlite3 = require("sqlite3");
const { spawn } = require( 'child_process' );
let ejs = require('ejs')
app.set('views', __dirname + '\\views')
app.use(bodyParser.urlencoded({extended: true}));
app.engine('html',  ejs.renderFile);

app.set('view engine', 'ejs');

function do_ci(cmd) {
    const dir = spawn( 'cmd', [ '/c', cmd ] );
    dir.stdout.on( 'data', ( data ) =>  console.log(`${data}`));
    dir.on( 'close', ( code ) => console.log( `child process exited with code ${code}` ) );
}

const db = new sqlite3.Database(__dirname + '\\sqlite3\\db.sqlite');

app.use(express.urlencoded({
  extended: false
}));

app.get(['/index.html', '/'], (req, res) => {
    res.render('index.html');
})

app.get('/xss', (req, res) => {
    const toEcho = req.query.toEcho;
     res.render('xss.ejs', {echo: toEcho});
});

app.post('/xss', (req, res) => {
     const toEcho = req.body.toEcho;
     res.render('xss.ejs', {echo: toEcho});
});

app.get('/ci', (req, res) => {
    console.log(req.query.cmd);
    let out = do_ci(req.query.cmd);
    res.render('ci.ejs', {ci: out});
});

app.post('/ci', (req, res) => {
    let out = do_ci(req.cmd);
    res.render('ci.ejs', {ci: out});
});

app.get('/login', (req, res) => {
    res.render('login.ejs', { newHtml: `` });
});

app.post('/login', (req, res) => {
    const username = req.body.username;
    const password = req.body.password;
    const query = `SELECT *
                   FROM users
                   WHERE Username = '${username}'
                     AND Password = '${password}';`;
    console.log(query)
    db.all(query, [], (err, rows) => {
        if (err) {
            throw err;
        }
        else if (rows.length === 0) {
            res.render('login.ejs', {newHtml: `Incorrect username or password`});
        }
        else {
            res.render('login.ejs', {newHtml: `Logged in as ${rows[0].Username}`});
        }
    });
});

app.listen(3000, () => {
    console.log('Server listening on port 3000');
});
