from sys import stderr
from typing import Union
from wrapper_interface import WrapperInterface
from requests_wrapper import RequestsWrapper
from selenium_wrapper import SeleniumWrapper, TIMEOUT


# todo add requests_interface.simple_get()
# todo sync requests_interface and selenium_interface (abstract interface class?) (sync function args)
# todo sync try-catch and raise the same errors (unique error for each class inheriting exception)
# todo sync communicator
# todo switch interface (for each) and reload data (cookies, auth, headers, ...) (reload? = True flag)
# todo check connection (local machine)
# todo ping
# todo nslookup
# todo reverse nslookup
# todo __is_ip_valid() (use in init)
# todo __is_url_valid()

class Communicator:
    def __init__(self, ip: str = "", url: str = "", headers: dict = None,
                 cookies: dict = None, auth: list = None, use_requests_interface=False,
                 hidden: bool = True, timeout: int = TIMEOUT):
        self._IP = ip
        self._URL = url
        self._headers = headers
        self._auth = auth
        self._cookies = cookies
        self._hidden = hidden
        self._timeout = timeout
        if use_requests_interface:
            self._active_interface = RequestsWrapper(ip, url, headers, cookies)
        else:
            self._active_interface = SeleniumWrapper(url, cookies, hidden, timeout)

    def get(self, url: str = "", data: dict = None, params: dict = None, allow_redirects: bool = True,
            auth: tuple = None, cert: Union[tuple, str] = None, cookies: dict = None, headers: dict = None):
        self.interface.get(url, data, params, allow_redirects, auth, cert, cookies, headers)

    def simple_get(self, url: str = "", cookies: dict = None):
        self.interface.simple_get(url, cookies)

    def post(self, url: str = "", data: dict = None, params: dict = None, allow_redirects: bool = True,
             auth: tuple = None, cert: Union[tuple, str] = None, cookies: dict = None, headers: dict = None):
        self.interface.post(url, data, params, allow_redirects, auth, cert, cookies, headers)

    def close_session(self):
        self.interface.close_session()

    def refresh_session(self):
        self.interface.refresh_session()

    def is_session_active(self):
        self.interface.is_session_active()

    def set_new_session_cookie(self):
        pass

    def create_new_session(self):
        self.interface.create_new_session()

    def add_header(self, header_name: str, header_val: str) -> None:
        self.interface.add_header(header_name, header_val)
        self.headers[header_name] = header_val

    def remove_header(self, header_name: str):
        self.interface.remove_header(header_name)
        del self.headers[header_name]

    def add_cookie(self, cookie_name: str, cookie_value: str):
        self.interface.add_cookie(cookie_name, cookie_value)
        self.cookies[cookie_name] = cookie_value

    def remove_cookie(self, cookie_name: str):
        self.interface.remove_cookie(cookie_name)
        del self.cookies[cookie_name]

    def get_alert_text(self) -> None:
        self.interface.get_alert_text()

    def remove_alerts(self) -> None:
        self.interface.remove_alerts()

    def send_keys(self) -> None:
        pass  # self.interface.send_keys()

    def get_element_by_name(self, name: str) -> None:
        self.interface.get_element_by_name(name)

    def get_element_by_id(self, id_str: str) -> None:
        self.interface.get_element_by_id(id_str)

    def change_auth(self, username: str, password: str) -> None:
        self.interface.change_auth(username, password)

    def remove_auth(self) -> None:
        self.interface.remove_auth()

    def is_selenium_interface(self) -> bool:
        return type(self.interface) == SeleniumWrapper

    def switch_interface(self, do_reload: bool = True) -> None:
        if type(self.interface) == SeleniumWrapper:     # switch to requests
            self.interface = RequestsWrapper(self.ip, self.url, self.headers, self.cookies)
        else:                                           # switch to selenium
            self.interface = SeleniumWrapper(self.url, self.cookies, self.hidden, self.timeout)

    def __str__(self) -> str:
        return self.interface.__str__()

    @property
    def ip(self) -> str:
        return self._IP

    @property
    def url(self) -> str:
        return self._URL

    @property
    def headers(self) -> dict:
        return self._headers

    @property
    def auth(self) -> list:
        return self._auth

    @property
    def cookies(self) -> dict:
        return self._cookies

    @property
    def interface(self) -> WrapperInterface:
        return self._active_interface

    @property
    def hidden(self) -> bool:
        return self._hidden

    @property
    def timeout(self) -> int:
        return self.timeout

    @ip.setter
    def ip(self, new_ip: str) -> None:
        self._IP = new_ip

    @url.setter
    def url(self, new_url: str) -> None:
        self._URL = new_url

    @headers.setter
    def headers(self, new_headers: dict) -> None:
        self._headers = new_headers

    @auth.setter
    def auth(self, new_auth: list) -> None:
        self._auth = new_auth

    @cookies.setter
    def cookies(self, new_cookies: dict) -> None:
        self._cookies = new_cookies

    @interface.setter
    def interface(self, interface: Union[RequestsWrapper, SeleniumWrapper]) -> None:
        self._active_interface = interface

    @hidden.setter
    def hidden(self, hidden: bool) -> None:
        self._hidden = hidden

    @timeout.setter
    def timeout(self, timeout: int) -> None:
        self._timeout = timeout
