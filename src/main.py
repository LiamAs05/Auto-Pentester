#! /usr/bin/python3
from sys import argv, stderr
from src.analyzer.page import Page
from src.managers.input_manager import InputManager
from src.communicator.communicator import Communicator, TIMEOUT
from src.managers.output_manager import OutputManager
from src.spider.spider import Spider, MAX_PAGES

NO_JSON_SUPPLIED = 1
JSON_INDEX = 1
MIN_ARGV_LENGTH = 1


def main() -> None:
    json_path, json = handle_input_json()
    spider = initialize_spider(json)  # spider's main function
    pages_found, communicator_instance = get_spider_data(spider)
    # here goes the attack managers
    handle_output_json(json_path, json, pages_found)


def get_spider_data(spider: Spider) -> tuple[dict[str, Page], Communicator]:
    """
    This function returns the pages that the spider found and communicator instance
    @param spider: Website crawler that finds the pages
    @return: dictionary of pages in the website and a communicator instance
    @rtype: tuple[dict[str, Page], communicator instance]
    """
    spider.logic()
    return spider.get_website().get_pages(), spider.communicator


def handle_input_json() -> tuple[str, dict | None]:
    """
    This function checks that the JSON file is valid
    If a file is invalid, it creates a valid template file in the cwd upon request
    @return: Parsed json file
    @rtype: dict
    """
    # setting input file path to argv[1] if it exists
    json_path = argv[JSON_INDEX] if len(argv) > MIN_ARGV_LENGTH else ""

    if not InputManager.check_for_json(argv):  # skip if input file is good
        try:
            json_path = InputManager.create_json_file()  # if input file is invalid/not given, ask user to generate
        except KeyboardInterrupt as e:
            print(e, file=stderr)
        if not json_path:  # if user didn't generate a template file
            exit(NO_JSON_SUPPLIED)  # exit with error code 1

    return json_path, InputManager.parse_input(json_path)


def handle_output_json(json_path: str, json: dict, pages_found: dict[str, Page]) -> None:
    """
    This function reports the findings of a program in JSON
    @param json_path: path of the input json file
    @param json: the input json
    @param pages_found: pages that the crawler reached
    @return: None
    """
    try:
        OutputManager.extract_info(json_path, json.get("attacks"), json.get("url"), list(pages_found.keys()))
    except KeyboardInterrupt as e:
        print(e, file=stderr)


def initialize_communicator(json: dict) -> Communicator:
    """
    Creating the communicator inside a function and returning for clarity purposes
    @param json: input json content
    @return: Communicator object
    """
    return Communicator(json.get("url"),
                        json.get("headers"),
                        json.get("cookies"),
                        json.get("auth", tuple()),
                        json.get("use_requests_interface", False),
                        json.get("hidden", True),
                        json.get("timeout", TIMEOUT))


def initialize_spider(json: dict) -> Spider:
    """
    Creating the communicator inside a function and returning for clarity purposes
    @param json: input json content
    @return: Communicator object
    """
    return Spider(json.get("url"),
                  json.get("blacklist"),
                  json.get("cookies"),
                  json.get("auth", tuple()),
                  json.get("max_pages", MAX_PAGES),
                  json.get("recursive", True))


def welcome_user() -> None:
    """
    This function prints a short introduction to the project and greets the user
    @return: None
    """
    print("Welcome!")


if __name__ == '__main__':
    main()
