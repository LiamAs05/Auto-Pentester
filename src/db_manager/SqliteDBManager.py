#! /usr/bin/python3
from typing import Union
from os.path import dirname, realpath, join, normpath
from os import sep, pardir
from sqlmodel import Session, create_engine, select
from src.db_manager.IDBManager import IDBManager
from src.db_manager.Payloads import Payloads


class SqliteDBManager(IDBManager):
    def __init__(self):
        db_dir = dirname(realpath(__file__))
        sqlite_url = f"sqlite:///{join(normpath(db_dir + sep + pardir), 'payloads.sqlite')}"
        self.__engine = create_engine(sqlite_url)
        self.__session: Union[Session, None] = None

    def open_db(self) -> None:
        """
        Opens a database connection and inits the cursor
        @return: None
        """
        self.__session = Session(self.__engine)

    def close_db(self) -> None:
        """
        Closes the current DB Connection
        @return: None
        """
        if self.__session.is_active:
            self.__session.close()

    def get_payloads(self, vulnerability: str, mode: int) -> list[str]:
        """
        Returns an attack payloads list
        @param vulnerability: type of payload
        @param mode: aggressive/normal
        @return: list of payloads
        @rtype: list[str]
        """
        statement = select(Payloads.payload).where(Payloads.vulnerability == vulnerability).where(Payloads.mode == mode)
        payloads = self.__session.exec(statement).all()
        return payloads
