#! /usr/bin/python3

from threading import Lock
from src.DBManager.IDBManager import Modes
from src.analyzer.page import Page
from src.analyzer.webElements.IElement import WebElement
from src.AttackManager.vulnerability import Vulnerability
from src.classificator.classificator import PageLevel
from src.AttackManager.attacks.IPentester import IPentester


class Element(IPentester):
    def attack(self, vulnerable_list: list[Vulnerability], list_lock: Lock) -> None:
        """
        This function is performs an XSS attack.
        @param vulnerable_list: The global list of vulnerabilities
        @param list_lock: list Mutex
        @return: None
        """

        payloads: list[str] = self._db_manager.get_payloads("XSS", Modes.NORMAL.value)
        pages_dict: dict[str, Page] = self._website.get_pages().items()

        for route, page in pages_dict:
            if page.type == PageLevel.PLAIN_TEXT_PAGE:
                continue

            self._communicator.url = route

            for inp in page.forms.inputs:
                if self.__is_escaping(inp, self._communicator.cookies):
                    continue

                self.__inject(inp, self._communicator.cookies, payloads)

                # todo add success check

    def __inject(self, inp: WebElement, cookies: dict, payloads: list[str]) -> None:
        """
        Injecting XSS into the page
        @param inp: input element in the page
        @param cookies: cookies given to website
        @param payloads: string payloads to inject
        @return: None
        """
        self._communicator.switch_to_selenium()     # making sure interface is selenium
        data = {inp: ""}    # making sure we don't override the dict in every iteration

        for payload in payloads:
            data[inp] = payload
            self._communicator.post(data=data, cookies=cookies)     # sending payload to site

    def __is_escaping(self, inp: WebElement, cookies: dict) -> bool:
        self._communicator.switch_to_selenium()

        """
        this is a demo unescaped html payload
        it's escaped form is:
        &lt;br&gt;&lt;p&gt;&lt;span&gt;Theres_&lt;/span&gt;N0_W4Y&lt;
        /p&gt;.This&lt;h1&gt;W45&lt;/h1&gt;Here&lt;br&gt;&lt;strong&g
        t;before&lt;/strong&gt;
        
        just to make sure it's unique
        """
        unescaped_payload = r'<br><p><span>Theres_</span>N0_W4Y</p>.' \
                            r'This<h1>W45</h1>Here<br><strong>before</strong>'

        self._communicator.post(data={inp: unescaped_payload}, cookies=cookies)

        return False    # todo check if the escaped form is present in the response
